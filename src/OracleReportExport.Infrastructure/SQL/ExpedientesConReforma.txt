SELECT I.CODESTACION,
         I.CODINSPECCION,
         I.FECHAINSPECCION,
         I.FECHAMATRICULACION,
         I.CODCATEGORIA AS CATEGORIA,
         CONCAT (I.CODCONSTRUCCION, I.CODUTILIZACION) AS CLASIFICACION,
         I.MATRICULA,
         I.MARCA,
         I.MODELO,
         I.CODSEPIVA AS COD_TIPO_INSPECCION,
         S.DESSEPIVA AS TIPO_INSPECCION,
         I.TIPOMOTOR,                                            --COMBUSTIBLE
         TP.DESMOTOR,
         TE.CODTIPO_ENAC,
         TE.DESCRIPCION AS DESCRIPCION_ENAC,
         I.DESNIVEL_EMISIONES AS NIVEL_EMISIONES,
         I.SUBNIVEL_EMISIONES AS SUBNIVEL_EMISIONES,
         IT.EMISIONES_NIVEL AS V_9,
         LISTAGG (IR.CODREFORMA, ', ') WITHIN GROUP (ORDER BY IR.CODREFORMA)
            AS REFORMA,
         I.Resultado,
         CASE NVL (TO_NUMBER (I.RESULTADO), -1)
            WHEN 0 THEN 'SIN_RESULTADO'
            WHEN 1 THEN 'FAVORABLE'
            WHEN 2 THEN 'FAVORABLE LEVE'
            WHEN 3 THEN 'DESFAVORABLE'
            WHEN 4 THEN 'NEGATIVO'
            ELSE 'DESCONOCIDO'
         END
            AS DESCRIPCION_RESULTADO,
         I.INDICA12 AS FASE,
         IT.Observaciones Observacion_Anverso,
         IT.REFORMAS_DILIGENCIA Observacion_Reverso,
         LISTAGG (IR.CODREFORMA || ' - ' || IR.DETALLE, CHR (10) || ' ')
            WITHIN GROUP (ORDER BY IR.CODREFORMA)
            AS DETALLE_CODIGOS_REFORMAS
    FROM INSPECCION I
         JOIN SEPIVA S ON I.CODSEPIVA = S.CODSEPIVA
         JOIN SEPIVA_ENAC SE
            ON     I.CODSEPIVA = SE.CODSEPIVA
               AND (   I.REFORMACONPROYECTO = SE.REFORMACONPROYECTO
                    OR SE.REFORMACONPROYECTO IS NULL)
         JOIN TIPOINSPECCION_ENAC TE ON SE.CODTIPO_ENAC = TE.CODTIPO_ENAC
         INNER JOIN INSPECCION_REFORMAS IR
            ON I.CODINSPECCION = IR.CODINSPECCION
         INNER JOIN INSPECCION_TRAMITES IT
            ON I.CODINSPECCION = IT.CODINSPECCION
         INNER JOIN TIPOSMOTOR TP ON I.TIPOMOTOR = TP.CODMOTOR
   WHERE     I.ANULADA = :Anulada
         AND I.FECHAINSPECCION >=:FechaDesde
         AND I.FECHAINSPECCION <=:FechaHasta
GROUP BY I.CODINSPECCION,
         I.CODESTACION,
         I.FECHAINSPECCION,
         I.MATRICULA,
         I.MARCA,
         I.MODELO,
         I.FECHAMATRICULACION,
         I.CODCATEGORIA,
         CONCAT (I.CODCONSTRUCCION, I.CODUTILIZACION),
         I.CODSEPIVA,
         S.DESSEPIVA,
         I.TIPOMOTOR,
         TP.DESMOTOR,
         IT.Observaciones,
         IT.REFORMAS_DILIGENCIA,
         TE.CODTIPO_ENAC,
         TE.DESCRIPCION,
         I.Resultado,
         CASE NVL (TO_NUMBER (I.RESULTADO), -1)
            WHEN 0 THEN 'SIN_RESULTADO'
            WHEN 1 THEN 'FAVORABLE'
            WHEN 2 THEN 'FAVORABLE LEVE'
            WHEN 3 THEN 'DESFAVORABLE'
            WHEN 4 THEN 'NEGATIVO'
            ELSE 'DESCONOCIDO'
         END,
         I.DESNIVEL_EMISIONES,
         I.SUBNIVEL_EMISIONES,
         I.INDICA12,
         IT.EMISIONES_NIVEL
ORDER BY TE.CODTIPO_ENAC, I.FECHAINSPECCION DESC